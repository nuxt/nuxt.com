<template>
  <div v-if="team" class="space-y-6">
    <UCard padded>
      <template #header>
        <h2 class="text-lg font-medium leading-6 u-text-gray-900">
          General
        </h2>
        <p class="mt-1 text-sm u-text-gray-400">
          Update your team informations.
        </p>
      </template>

      <div class="space-y-6">
        <UFormGroup name="slug" label="Slug" :help="form.slug !== slug ? `Your team slug will be renamed to “${slug}”` : 'This is your team\'s URL namespace on Nuxt.'" required class="relative w-full lg:max-w-xs">
          <div class="flex items-center">
            <span class="inline-flex items-center px-2 py-2 text-sm border border-r-0 rounded-l-lg u-bg-gray-50 u-border-gray-200 u-text-gray-500">
              nuxt.com/@
            </span>

            <UInput
              v-model="form.slug"
              name="slug"
              required
              autocomplete="off"
              class="w-full"
              placeholder="nuxt"
              appearance="darken"
              custom-class="rounded-l-none"
            />
          </div>
        </UFormGroup>

        <UFormGroup name="name" label="Name" help="This is your team's visible name within Nuxt. For example, the name of your company or department." required>
          <UInput
            v-model="form.name"
            name="name"
            required
            placeholder="Nuxt"
            autocomplete="off"
            appearance="darken"
            class="w-full lg:max-w-xs"
          />
        </UFormGroup>

        <UFormGroup name="avatar" label="Avatar" help="An avatar is optional but strongly recommended.">
          <div class="flex items-center gap-3">
            <UAvatar :src="avatar" gradient />

            <input ref="file" name="avatar" type="file" class="hidden" @change="onFileUpload">

            <UButton label="Change" size="sm" variant="secondary" @click="$refs.file.click()" />
          </div>
        </UFormGroup>
      </div>

      <template #footer>
        <div class="flex items-center justify-end">
          <UButton
            type="submit"
            :loading="updating"
            label="Save"
            @click="onSubmit()"
          />
        </div>
      </template>
    </UCard>

    <UCard padded>
      <div :class="{ 'opacity-50 cursor-not-allowed': !isOwner }">
        <h2 class="text-lg font-medium leading-6 u-text-gray-900">
          Leave team
        </h2>
        <p class="mt-1 text-sm u-text-gray-400">
          Revoke your access to this team. Any resources you've added to the Team will remain.
        </p>
      </div>
      <template #footer>
        <div class="flex items-center" :class="{ 'justify-end': isOwner }">
          <UButton
            v-if="isOwner"
            :loading="leaving"
            variant="red"
            label="Leave team"
            @click="onLeave()"
          />
          <p v-else class="text-sm py-2.5 -my-px">
            To leave this team, ensure at least one more member has the Owner role.
          </p>
        </div>
      </template>
    </UCard>

    <UCard padded>
      <div :class="{ 'opacity-50 cursor-not-allowed': !isOwner }">
        <h2 class="text-lg font-medium leading-6 u-text-gray-900">
          Delete team
        </h2>
        <p class="mt-1 text-sm u-text-gray-400">
          Permanently remove your team and all of its contents from Nuxt. This action is not reversible – please continue with caution.
        </p>
      </div>
      <template #footer>
        <div class="flex items-center" :class="{ 'justify-end': isOwner }">
          <UButton
            v-if="isOwner"
            :loading="deleting"
            variant="red"
            label="Delete team"
            @click="onDelete()"
          />
          <p v-else class="text-sm py-2.5 -my-px">
            You need to be an Owner of this team in order to delete it.
          </p>
        </div>
      </template>
    </UCard>

    <UAlertDialog
      v-model="leaveModal"
      icon="heroicons-outline:x"
      icon-class="text-red-600"
      icon-wrapper-class="w-12 h-12 bg-red-100 sm:h-10 sm:w-10"
      title="Leave team"
      description="Are you sure you want to leave the team?"
      @confirm="confirmLeave()"
    />
    <UAlertDialog
      v-model="deleteModal"
      icon="heroicons-outline:x"
      icon-class="text-red-600"
      icon-wrapper-class="w-12 h-12 bg-red-100 sm:h-10 sm:w-10"
      title="Delete team"
      description="Are you sure you want to delete the team? This action cannot be undone!"
      @confirm="confirmDelete()"
    />
  </div>
  <div v-else class="space-y-6">
    <UCard padded />
  </div>
</template>

<script setup lang="ts">
import { omit } from 'lodash-es'
import slugify from '@sindresorhus/slugify'
import type { PropType, Ref } from 'vue'
import type { Team, User } from '~/types'

const props = defineProps({
  team: {
    type: Object as PropType<Team>,
    default: null
  }
})

const router = useRouter()
const client = useStrapiClient()
const user = useStrapiUser() as Ref<User>
const { $toast } = useNuxtApp()

const avatar = ref(props.team?.avatar?.url)
const file = ref(null)
const form = reactive({ name: props.team?.name, slug: props.team?.slug, avatar: '' })
const updating = ref(false)
const deleting = ref(false)
const leaving = ref(false)
const leaveModal = ref(false)
const deleteModal = ref(false)

const updateUserTeam = (updatedTeam) => {
  const { team } = user.value?.memberships?.find(membership => membership.team.id === updatedTeam.id) || {}
  if (team) {
    Object.assign(team, updatedTeam)
    // eslint-disable-next-line vue/no-mutating-props
    Object.assign(props.team, omit(updatedTeam, ['slug']))
  }
}

const removeTeamFromUser = () => {
  const index = user.value?.memberships?.findIndex(m => m.team.id === props.team.id)
  if (index > -1) {
    user.value.memberships.splice(index, 1)
  }
}

const onSubmit = async () => {
  updating.value = true

  try {
    const formData = new FormData()
    if (form.avatar) { formData.append('files.avatar', form.avatar) }
    formData.append('data', JSON.stringify(omit(form, ['avatar'])))

    const team = await client<Team>(`/teams/${props.team.id}`, {
      method: 'PUT',
      body: formData
    })

    updateUserTeam(team)

    if (team.slug !== props.team.slug) {
      // Replace `name` param in url
      router.replace({ name: '@team-settings', params: { team: team.slug } })
    }

    $toast.success({
      title: 'Success',
      description: 'Your team settings have been saved.'
    })
  } catch (e) {}

  updating.value = false
}

const onLeave = () => {
  leaveModal.value = true
}

const confirmLeave = async () => {
  leaving.value = true

  try {
    await client(`/teams/${props.team.id}/members/${user.value.id}`, {
      method: 'DELETE'
    })

    removeTeamFromUser()

    router.push({ name: '@team-projects', params: { team: user.value.username } })
  } catch (e) {
    leaving.value = false
  }
}

const onDelete = () => {
  deleteModal.value = true
}

const confirmDelete = async () => {
  deleting.value = true

  try {
    await client(`/teams/${props.team.id}`, {
      method: 'DELETE'
    })

    removeTeamFromUser()

    router.push({ name: '@team-projects', params: { team: user.value.username } })
  } catch (e) {
    deleting.value = false
  }
}

const onFileUpload = () => {
  form.avatar = file.value.files[0]

  avatar.value = URL.createObjectURL(form.avatar)
}

const slug = computed(() => {
  return slugify(form.slug)
})

const isOwner = computed(() => {
  const member = props.team?.members?.find(member => member.user.id === user.value.id)

  return member?.role === 'owner'
})
</script>
